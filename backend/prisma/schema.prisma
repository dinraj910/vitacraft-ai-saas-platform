// prisma/schema.prisma
// VitaCraft AI — Full Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────

enum Role {
  USER
  ADMIN
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum GenerationType {
  RESUME
  COVER_LETTER
  JOB_ANALYSIS
  RESUME_ANALYSIS
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
}

// ─────────────────────────────────────────
// USER
// ─────────────────────────────────────────

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  passwordHash    String
  name            String
  role            Role     @default(USER)
  isEmailVerified Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  creditAccount CreditAccount?
  subscription  Subscription?
  generations   Generation[]
  refreshTokens RefreshToken[]
  files         UserFile[]

  @@index([email])
}

// ─────────────────────────────────────────
// REFRESH TOKENS
// ─────────────────────────────────────────

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ─────────────────────────────────────────
// CREDIT SYSTEM
// ─────────────────────────────────────────

model CreditAccount {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(5) // Free plan: 5 credits on signup
  totalUsed Int      @default(0)
  updatedAt DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CreditTransaction[]

  @@index([userId])
}

model CreditTransaction {
  id              String   @id @default(cuid())
  creditAccountId String
  amount          Int // Positive = added, Negative = used
  reason          String // "AI_GENERATION" | "SUBSCRIPTION_RENEWAL" | "ADMIN_GRANT"
  generationId    String?
  createdAt       DateTime @default(now())

  creditAccount CreditAccount @relation(fields: [creditAccountId], references: [id])

  @@index([creditAccountId])
}

// ─────────────────────────────────────────
// SUBSCRIPTION & BILLING
// ─────────────────────────────────────────

model Plan {
  id             String   @id @default(cuid())
  name           PlanType @unique
  displayName    String
  monthlyCredits Int
  priceUSD       Float
  stripePriceId  String   @unique
  features       Json
  isActive       Boolean  @default(true)

  subscriptions Subscription[]
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  planId               String
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?
  status               SubscriptionStatus @default(INACTIVE)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([stripeSubscriptionId])
}

// ─────────────────────────────────────────
// AI GENERATIONS
// ─────────────────────────────────────────

model Generation {
  id           String         @id @default(cuid())
  userId       String
  type         GenerationType
  prompt       String         @db.Text
  response     String         @db.Text
  model        String
  creditsUsed  Int            @default(1)
  processingMs Int?
  s3Key        String?
  createdAt    DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ─────────────────────────────────────────
// FILE STORAGE
// ─────────────────────────────────────────

model UserFile {
  id        String   @id @default(cuid())
  userId    String
  s3Key     String   @unique
  fileName  String
  mimeType  String
  sizeBytes Int
  category  String // "resume_pdf" | "cover_letter_pdf" | "upload"
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
